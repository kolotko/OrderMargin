@page "/"
@using Dto
@using Radzen
@using Radzen.Blazor
@using OrderMarginApp.Components.Order
@inject DialogService DialogService

<RadzenSteps CanChange="@CanChange">
    <Steps >
        <RadzenStepsItem Text="Kalkulator cen">
            <PriceCalculatorComponent Prices="_prices" PriceCalculatorReady="@PriceCalculatorReadyEvent"></PriceCalculatorComponent>
        </RadzenStepsItem>
        <RadzenStepsItem Text="Marżowość">
            <OrderFileComponent Orders="_orders" Skus="_skus" OrderFileReady="@OrderFileReadyEvent"></OrderFileComponent>
        </RadzenStepsItem>
        <RadzenStepsItem Text="Komplet danych">
            <DataCompletionComponent PricesDto="_prices" OrdersDto="_orders"></DataCompletionComponent>
        </RadzenStepsItem>
        <RadzenStepsItem Text="Statystyki">
            <StatisticsComponent></StatisticsComponent>
        </RadzenStepsItem>
    </Steps>
</RadzenSteps>

@code {
    private List<PriceCalculatorDto>? _prices;
    private List<string?>? _skus;
    private List<OrderFileDto>? _orders;
    
    protected override async Task OnInitializedAsync()
    {
        _prices = new();
        await base.OnInitializedAsync();
    }
    
    private void PriceCalculatorReadyEvent(List<PriceCalculatorDto> result)
    {
        _prices = result;
    }
    
    private void OrderFileReadyEvent(List<OrderFileDto> result)
    {
        _orders = result;
    }
    
    private async Task CanChange(StepsCanChangeEventArgs args)
    {
        // nie pozwól na cofnięcie się
        Console.WriteLine(args.NewIndex);
        Console.WriteLine(args.SelectedIndex);
        if (args.NewIndex < args.SelectedIndex)
        {
            await DialogService.Alert(
                "Proces nie pozwala na cofanie się",
                "Uwaga!",
                new ConfirmOptions()
                {
                    CloseDialogOnEsc = false,
                    CloseDialogOnOverlayClick = false,
                    ShowClose = false,
                    OkButtonText = "Ok",
                });
            args.PreventDefault();
            return;
        }
        
        if (args.SelectedIndex == 0 && _prices!.Count > 0)
        {
            var allRecordValid = _prices!.All(x => string.IsNullOrEmpty(x.ValidatorResult));
            if (allRecordValid)
            {
                _skus = _prices!.Select(y => y.Sku).ToList();
                return;
            }
        }
        
        if (args.SelectedIndex == 1 && _orders!.Count > 0)
        {
            var allRecordValid = _orders!.All(x => string.IsNullOrEmpty(x.ValidatorResult));
            if (allRecordValid)
            {
                return;
            }
        }
        
        await DialogService.Alert(
            "Nie wszystkie rekordy są prawidłowe",
            "Uwaga!",
            new ConfirmOptions()
            {
                CloseDialogOnEsc = false,
                CloseDialogOnOverlayClick = false,
                ShowClose = false,
                OkButtonText = "Ok",
            });
        args.PreventDefault();
    }
}